<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Buddy - Chapter 1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --text: #212529;
            --bg: #fff;
            --muted: #f8f9fa;
            --border: #e9ecef;
            --accent: #fd7e14;
            --accent-2: #e87312;
            --header-bg: #212529;
            --header-fg: #f8f9fa;
            --ok: #16a34a;
            --ok-soft: #dcfce7;
            --bad: #dc2626;
            --bad-soft: #fee2e2;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.3;
            margin: 0;
            padding: 0;
        }

        /* Subtle attention highlight for primary action */
        .btn.highlight {
            position: relative;
            box-shadow: 0 0 0 3px rgba(253, 126, 20, 0.45);
            animation: pulseOutline 1.2s ease-in-out infinite;
        }

        @keyframes pulseOutline {
            0% { box-shadow: 0 0 0 0 rgba(253, 126, 20, 0.55); }
            50% { box-shadow: 0 0 0 6px rgba(253, 126, 20, 0.15); }
            100% { box-shadow: 0 0 0 0 rgba(253, 126, 20, 0.0); }
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* Desktop responsive design - NO extra padding that creates scrollbars */
        @media (min-width: 768px) {
            .app-container {
                max-width: 600px;
                margin: 0 auto;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }
            
            .word-display {
                padding: 20px 16px;
            }
            
            .hindi-word {
                font-size: 2.2rem !important;
            }
            
            .english-word {
                font-size: 1.2rem !important;
            }
            
            .controls {
                gap: 10px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }

        @media (min-width: 1024px) {
            .app-container {
                max-width: 700px;
            }
            
            .hindi-word {
                font-size: 2.4rem !important;
            }
            
            .english-word {
                font-size: 1.3rem !important;
            }
        }

        /* Header - Fixed 32px */
        .app-header {
            height: 32px;
            background: var(--header-bg);
            color: var(--header-fg);
            padding: 0 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-title {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .chapter-badge {
            background: var(--accent);
            color: #fff;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Microphone Status in Header */
        .mic-status-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
        }

        .mic-indicator-header {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--bad);
            transition: all 0.3s ease;
        }

        .mic-indicator-header.ready {
            background: var(--ok);
        }

        .mic-indicator-header.listening {
            background: var(--accent);
            animation: blink 1s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Progress - Fixed 24px */
        .progress-section {
            height: 24px;
            background: var(--muted);
            border-bottom: 1px solid var(--border);
            padding: 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .progress-label {
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text);
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-score {
            font-weight: 700;
            color: var(--accent);
            font-size: 0.75rem;
        }

        /* Main Content - Fixed layout, no scrolling */
        .main-content {
            flex: 1;
            padding: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
            height: calc(100vh - 32px - 24px - 48px);
        }

        /* Microphone Setup Screen */
        .setup-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex: 1;
            padding: 20px;
        }

        .setup-card {
            background: linear-gradient(135deg, var(--accent), #fbbf24);
            color: white;
            padding: 32px 24px;
            border-radius: 16px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(253, 126, 20, 0.3);
        }

        .setup-card h2 {
            font-size: 1.4rem;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .setup-card p {
            margin-bottom: 24px;
            opacity: 0.95;
            line-height: 1.4;
            font-size: 0.9rem;
        }

        .setup-btn {
            background: white;
            color: var(--accent);
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .setup-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .setup-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Game Card */
        .game-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .game-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 2px;
            color: var(--text);
        }

        .game-subtitle {
            color: #6c757d;
            margin-bottom: 8px;
            font-size: 0.75rem;
        }

        /* Word Display */
        .word-display {
            text-align: center;
            padding: 16px 12px;
            background: var(--muted);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .hindi-word {
            font-size: clamp(1.4rem, 8vw, 1.8rem);
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
            line-height: 1;
        }

        .english-word {
            font-size: clamp(0.9rem, 5vw, 1.1rem);
            color: var(--text);
            font-weight: 500;
            margin-bottom: 2px;
        }

        .phonetic {
            font-size: 0.75rem;
            color: #6c757d;
            font-style: italic;
        }

        /* Timer */
        .timer-display {
            text-align: center;
            margin-bottom: 8px;
        }

        .timer-circle {
            width: 50px;
            height: 50px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 4px;
            font-size: 1.1rem;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .timer-circle.active {
            border-color: var(--accent);
            color: var(--accent);
            animation: pulse 1s ease-in-out infinite;
        }

        .timer-circle.paused {
            border-color: #6c757d;
            color: #6c757d;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .timer-text {
            color: #6c757d;
            font-size: 0.7rem;
        }

        /* Mic Status */
        .mic-status {
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 0.7rem;
            color: #6c757d;
        }

        .mic-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--border);
            transition: background-color 0.3s ease;
        }

        .mic-indicator.active {
            background: var(--bad);
            animation: blink 1s ease-in-out infinite;
        }

        /* Feedback */
        .feedback-section {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: none;
        }

        .feedback-section.show {
            display: block;
        }

        .feedback-section.correct {
            background: var(--ok-soft);
            border: 1px solid var(--ok);
            color: var(--ok);
        }

        .feedback-section.incorrect {
            background: var(--bad-soft);
            border: 1px solid var(--bad);
            color: var(--bad);
        }

        .feedback-icon {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .feedback-text {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .feedback-hint {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* Buttons */
        .btn {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            min-height: 32px;
            justify-content: center;
        }

        .btn:hover:not(:disabled) {
            background: var(--accent-2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: var(--muted);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn.secondary:hover:not(:disabled) {
            background: var(--border);
        }

        .btn.recording {
            background: var(--bad);
            animation: pulse 1s ease-in-out infinite;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-top: auto;
            flex-shrink: 0;
        }

        .controls .btn {
            flex: 1;
        }

        /* Navigation - Fixed 48px */
        .nav-controls {
            height: 48px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
            background: var(--muted);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .nav-controls .btn {
            flex: 1;
            margin: 0 4px;
            max-width: 120px;
        }

        .nav-controls .btn.center {
            flex: 1.2;
        }

        .nav-controls .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #e5e5e5;
            color: #999;
        }

        .nav-controls .btn {
            font-size: 0.8rem;
            padding: 8px 12px;
            min-height: 32px;
        }

        /* Hidden utility */
        .hidden {
            display: none !important;
        }

        /* Confetti Animation */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 1000;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--accent);
            animation: confetti-fall 3s linear forwards;
        }

        .confetti-piece:nth-child(odd) {
            background: var(--ok);
            width: 8px;
            height: 8px;
            animation-duration: 3.5s;
        }

        .confetti-piece:nth-child(3n) {
            background: #fbbf24;
            border-radius: 50%;
            width: 6px;
            height: 6px;
            animation-duration: 4s;
        }

        .confetti-piece:nth-child(4n) {
            background: #8b5cf6;
            animation-duration: 2.5s;
        }

        .confetti-piece:nth-child(5n) {
            background: #ef4444;
            border-radius: 50%;
            animation-duration: 3.2s;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Success celebration shake */
        .celebrate {
            animation: celebrate-shake 0.6s ease-in-out;
        }

        @keyframes celebrate-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) scale(1.02); }
            75% { transform: translateX(5px) scale(1.02); }
        }

        /* Speak Button Arrows */
        .btn-with-arrows {
            position: relative;
        }

        .btn-with-arrows::before,
        .btn-with-arrows::after {
            content: "→";
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent);
            font-size: 1.2rem;
            font-weight: bold;
            animation: arrow-pulse 1.5s ease-in-out infinite;
        }

        .btn-with-arrows::before {
            left: -20px;
            transform: translateY(-50%) scaleX(-1);
        }

        .btn-with-arrows::after {
            right: -20px;
        }

        @keyframes arrow-pulse {
            0%, 100% { opacity: 0.6; transform: translateY(-50%) translateX(0); }
            50% { opacity: 1; transform: translateY(-50%) translateX(3px); }
        }

        .btn-with-arrows::before {
            animation: arrow-pulse-left 1.5s ease-in-out infinite;
        }

        @keyframes arrow-pulse-left {
            0%, 100% { opacity: 0.6; transform: translateY(-50%) scaleX(-1) translateX(0); }
            50% { opacity: 1; transform: translateY(-50%) scaleX(-1) translateX(-3px); }
        }

        /* Countdown styles */
        .countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(22, 163, 74, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 10;
        }

        .countdown-number {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            animation: countdown-bounce 0.8s ease-in-out;
        }

        @keyframes countdown-bounce {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Mobile adjustments */
        @media (max-width: 380px) {
            .app-container {
                max-width: 100vw;
                margin: 0;
            }
            
            .controls .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Confetti Animation Container -->
        <div class="confetti-container" id="confettiContainer"></div>
        
        <!-- Header: Fixed 32px -->
        <header class="app-header">
            <div class="app-title">English Buddy</div>
            <div class="header-controls">
                <div class="mic-status-header">
                    <div class="mic-indicator-header" id="micIndicatorHeader"></div>
                    <span id="micStatusHeader">Setting up...</span>
                </div>
                <div class="chapter-badge">Chapter 1</div>
            </div>
        </header>

        <!-- Progress: Fixed 24px -->
        <div class="progress-section">
            <span class="progress-label">Progress</span>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <span class="progress-score" id="progressScore">0/33</span>
        </div>

        <!-- Main Content: Flexible -->
        <main class="main-content">
            <!-- Microphone Setup Screen -->
            <div class="setup-screen" id="setupScreen">
                <div class="setup-card">
                    <h2>🎤 Microphone Setup</h2>
                    <p>This app helps you practice English pronunciation. We need microphone access once to listen to your speech throughout the session.</p>
                    <button class="setup-btn" id="setupMicBtn">Enable Microphone</button>
                </div>
            </div>

            <!-- Main Game Area -->
            <div class="game-card hidden" id="gameArea">
                <h2 class="game-title" id="gameTitle">Word Learning</h2>
                <p class="game-subtitle" id="gameSubtitle">Learn pronunciation and meaning</p>

                <!-- Word Display -->
                <div class="word-display" id="wordDisplay">
                    <div class="hindi-word" id="hindiWord">पानी</div>
                    <div class="english-word" id="englishWord">Water</div>
                    <div class="phonetic" id="phoneticText">paa-nee</div>
                </div>

                <!-- Timer -->
                <div class="timer-display" id="timerDisplay">
                    <div class="timer-circle" id="timerCircle">10</div>
                    <div class="timer-text">seconds to speak</div>
                </div>

                <!-- Mic Status -->
                <div class="mic-status">
                    <div class="mic-indicator" id="micIndicator"></div>
                    <span id="micStatus">Listen carefully, then try to repeat</span>
                </div>

                <!-- Feedback Section -->
                <div class="feedback-section" id="feedbackSection">
                    <div class="feedback-icon" id="feedbackIcon">✅</div>
                    <div class="feedback-text" id="feedbackText">Great pronunciation!</div>
                    <div class="feedback-hint" id="feedbackHint">Keep practicing!</div>
                </div>

                <!-- Controls -->
                <div class="controls">
                    <button class="btn" id="listenBtn">🔊 Listen</button>
                    <button class="btn secondary" id="recordBtn">🎤 Speak</button>
                </div>
            </div>
        </main>

        <!-- Navigation: Fixed 48px -->
        <div class="nav-controls">
            <button class="btn secondary" id="backBtn">← Back</button>
            <button class="btn secondary center" id="selectLessonBtn">Select Lesson</button>
            <button class="btn secondary" id="skipBtn">Skip →</button>
        </div>
    </div>

    <script>
        class HindiLearningApp {
            constructor() {
                this.currentIndex = 0;
                this.score = 0;
                this.totalAttempts = 0;
                this.timer = null;
                this.timeRemaining = 0;
                this.isRecording = false;
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                this.audioStream = null; // NEW: Persistent audio stream
                this.micPermissionGranted = false; // NEW: Track permission state
                this.voices = [];
                this.voicesReady = false;

                this.vocabulary = [
                    { hindi: 'पानी', english: 'water', phonetic: 'paa-nee' },
                    { hindi: 'आग', english: 'fire', phonetic: 'aag' },
                    { hindi: 'दूध', english: 'milk', phonetic: 'doodh' },
                    { hindi: 'रोटी', english: 'bread', phonetic: 'ro-ti' },
                    { hindi: 'चावल', english: 'rice', phonetic: 'chaa-val' },
                    { hindi: 'दाल', english: 'lentils', phonetic: 'daal' },
                    { hindi: 'सब्जी', english: 'vegetables', phonetic: 'sab-zi' },
                    { hindi: 'फल', english: 'fruit', phonetic: 'phal' },
                    { hindi: 'मिठाई', english: 'sweets', phonetic: 'mi-thai' },
                    { hindi: 'नमक', english: 'salt', phonetic: 'na-mak' }
                ];

                this.totalItems = this.vocabulary.length;
                
                this.initializeElements();
                this.ensureVoicesReady();
                this.bindEvents();
                this.updateProgress();
            }

            async ensureVoicesReady() {
                return new Promise(resolve => {
                    if (!this.synthesis) { resolve(); return; }
                    const load = () => {
                        const vs = this.synthesis.getVoices();
                        if (vs && vs.length) {
                            this.voices = vs;
                            this.voicesReady = true;
                            resolve();
                        } else {
                            setTimeout(load, 150);
                        }
                    };
                    try {
                        this.synthesis.onvoiceschanged = () => {
                            const vs = this.synthesis.getVoices();
                            if (vs && vs.length) {
                                this.voices = vs;
                                this.voicesReady = true;
                                resolve();
                            }
                        };
                    } catch (_) {}
                    load();
                });
            }

            initializeElements() {
                // Setup elements
                this.setupScreen = document.getElementById('setupScreen');
                this.setupMicBtn = document.getElementById('setupMicBtn');
                
                // Main elements
                this.gameArea = document.getElementById('gameArea');
                this.gameTitle = document.getElementById('gameTitle');
                this.gameSubtitle = document.getElementById('gameSubtitle');
                this.hindiWord = document.getElementById('hindiWord');
                this.englishWord = document.getElementById('englishWord');
                this.phoneticText = document.getElementById('phoneticText');
                this.wordDisplay = document.getElementById('wordDisplay');

                // Controls
                this.listenBtn = document.getElementById('listenBtn');
                this.recordBtn = document.getElementById('recordBtn');
                this.backBtn = document.getElementById('backBtn');
                this.skipBtn = document.getElementById('skipBtn');
                this.selectLessonBtn = document.getElementById('selectLessonBtn');

                // Timer and feedback
                this.timerDisplay = document.getElementById('timerDisplay');
                this.timerCircle = document.getElementById('timerCircle');
                this.feedbackSection = document.getElementById('feedbackSection');
                this.feedbackIcon = document.getElementById('feedbackIcon');
                this.feedbackText = document.getElementById('feedbackText');
                this.feedbackHint = document.getElementById('feedbackHint');

                // Status
                this.micIndicator = document.getElementById('micIndicator');
                this.micStatus = document.getElementById('micStatus');
                this.micIndicatorHeader = document.getElementById('micIndicatorHeader');
                this.micStatusHeader = document.getElementById('micStatusHeader');
                this.progressScore = document.getElementById('progressScore');
                this.progressFill = document.getElementById('progressFill');
                
                // Animation elements
                this.confettiContainer = document.getElementById('confettiContainer');
            }

            bindEvents() {
                this.setupMicBtn.addEventListener('click', () => this.setupMicrophone());
                this.listenBtn.addEventListener('click', () => this.playAudio());
                this.recordBtn.addEventListener('click', () => this.toggleRecording());
                this.backBtn.addEventListener('click', () => this.goBack());
                this.skipBtn.addEventListener('click', () => this.nextItem());
                this.selectLessonBtn.addEventListener('click', () => this.showLessonSelection());
            }

            // NEW: One-time microphone setup
            async setupMicrophone() {
                this.setupMicBtn.textContent = 'Setting up...';
                this.setupMicBtn.disabled = true;
                this.updateMicStatus('setting-up', 'Setting up...');

                try {
                    // Request persistent microphone access
                    this.audioStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    
                    this.micPermissionGranted = true;
                    this.updateMicStatus('ready', 'Ready');
                    
                    // Initialize speech recognition once
                    await this.initializeSpeechRecognition();
                    
                    // Show main app
                    this.showMainApp();
                    
                } catch (error) {
                    console.error('Microphone setup failed:', error);
                    this.handleMicrophoneError(error);
                }
            }

            // NEW: Initialize speech recognition once with persistent stream
            async initializeSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    throw new Error('Speech recognition not supported');
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                this.recognition.maxAlternatives = 3;
                this.recognition.lang = 'en-US';

                this.recognition.onstart = () => {
                    this.isRecording = true;
                    this.updateMicStatus('listening', 'Listening...');
                    this.micIndicator.classList.add('active');
                    this.micStatus.textContent = 'Listening...';
                    this.recordBtn.textContent = '🔴 Stop';
                    this.recordBtn.classList.add('recording');
                    this.stopTimer();
                };

                this.recognition.onend = () => {
                    this.isRecording = false;
                    this.updateMicStatus('ready', 'Ready');
                    this.micIndicator.classList.remove('active');
                    this.micStatus.textContent = 'Click to try again';
                    this.recordBtn.textContent = '🎤 Speak';
                    this.recordBtn.classList.remove('recording');
                };

                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.toLowerCase().trim();
                    this.handleSpeechResult(transcript);
                };

                this.recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    this.isRecording = false;
                    this.updateMicStatus('ready', 'Ready');
                    this.micIndicator.classList.remove('active');
                    this.recordBtn.textContent = '🎤 Speak';
                    this.recordBtn.classList.remove('recording');
                    this.stopTimer();
                    
                    if (event.error === 'no-speech') {
                        this.showFeedback(false, 'No speech detected', 'Try speaking more clearly');
                    }
                };
            }

            handleMicrophoneError(error) {
                this.setupMicBtn.textContent = 'Try Again';
                this.setupMicBtn.disabled = false;
                
                let message = 'Unable to access microphone. ';
                if (error.name === 'NotAllowedError') {
                    message += 'Please allow microphone access and try again.';
                    this.updateMicStatus('blocked', 'Blocked');
                } else if (error.name === 'NotFoundError') {
                    message += 'No microphone found. Please check your device.';
                    this.updateMicStatus('error', 'No mic');
                } else {
                    message += 'Please check your microphone settings.';
                    this.updateMicStatus('error', 'Error');
                }
                
                this.showFeedback(false, 'Microphone Setup Failed', message);
            }

            // NEW: Update microphone status in header
            updateMicStatus(status, text) {
                this.micStatusHeader.textContent = text;
                this.micIndicatorHeader.className = 'mic-indicator-header';
                
                switch(status) {
                    case 'ready':
                        this.micIndicatorHeader.classList.add('ready');
                        break;
                    case 'listening':
                        this.micIndicatorHeader.classList.add('listening');
                        break;
                    case 'blocked':
                    case 'error':
                        // Keep default red color
                        break;
                }
            }

            showMainApp() {
                this.setupScreen.classList.add('hidden');
                this.gameArea.classList.remove('hidden');
                this.showCurrentWord();
            }

            showCurrentWord() {
                const item = this.vocabulary[this.currentIndex];
                if (!item) {
                    this.showResults();
                    return;
                }

                this.hindiWord.textContent = item.hindi;
                this.englishWord.textContent = item.english;
                this.phoneticText.textContent = item.phonetic;
                
                this.feedbackSection.classList.remove('show');
                // Remove any previous arrows
                this.recordBtn.classList.remove('btn-with-arrows');
                this.startTimer(10);
                
                // Auto-play audio and then show arrow guidance
                setTimeout(() => {
                    this.playAudio();
                    // Show arrows after audio plays to guide user to speak
                    setTimeout(() => {
                        this.recordBtn.classList.add('btn-with-arrows');
                        this.micStatus.textContent = 'Click the speak button to practice pronunciation';
                    }, 1500);
                }, 500);
            }

            async playAudio() {
                const item = this.vocabulary[this.currentIndex];
                if (!item) return;

                if (!this.synthesis) return;
                await this.ensureVoicesReady();
                this.stopAllSpeech();
                
                const utterance = new SpeechSynthesisUtterance(item.english);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                
                if (this.voices && this.voices.length) {
                    const preferred = this.voices.find(v => /en(-|_)US/i.test(v.lang)) || this.voices.find(v => v.lang.startsWith('en'));
                    if (preferred) utterance.voice = preferred;
                }
                
                this.synthesis.speak(utterance);
                this.micStatus.textContent = `Say "${item.english}" for Hindi "${item.hindi}"`;
            }

            stopAllSpeech() {
                if (this.synthesis) {
                    try { this.synthesis.cancel(); } catch (_) {}
                }
            }

            // IMPROVED: Use existing recognition object, no new permissions
            toggleRecording() {
                if (!this.micPermissionGranted || !this.recognition) {
                    this.showFeedback(false, 'Microphone not ready', 'Please set up microphone access first');
                    return;
                }

                if (this.isRecording) {
                    this.recognition.stop();
                } else {
                    this.startRecording();
                }
            }

            startRecording() {
                try {
                    this.feedbackSection.classList.remove('show');
                    // Remove arrow guidance when user clicks to speak
                    this.recordBtn.classList.remove('btn-with-arrows');
                    this.recognition.start(); // Uses existing stream, no permission request
                    this.startTimer(10);
                } catch (error) {
                    console.error('Failed to start recording:', error);
                    this.showFeedback(false, 'Recording failed', 'Please try again');
                }
            }

            handleSpeechResult(transcript) {
                const item = this.vocabulary[this.currentIndex];
                const targetEnglish = item.english.toLowerCase();
                
                const isCorrect = transcript.includes(targetEnglish) ||
                                this.calculateSimilarity(transcript, targetEnglish) > 0.7;
                
                this.totalAttempts++;
                
                if (isCorrect) {
                    this.score++;
                    this.showFeedback(true, 'Perfect pronunciation!', 'Keep up the great work!');
                    
                    // Celebrate with confetti and animations
                    this.celebrateSuccess();
                    this.playSuccessSound();
                    
                    // Audio congratulations
                    setTimeout(() => {
                        this.speakEnglish('Excellent! Great job!');
                        setTimeout(() => {
                            const hindiCongrats = `बहुत अच्छा! ${item.hindi} को English में ${item.english} कहते हैं।`;
                            this.speakHindi(hindiCongrats);
                        }, 2000);
                    }, 500);
                    
                    // Start countdown and move to next word
                    setTimeout(() => {
                        this.startCountdownToNext();
                    }, 4000);
                    
                } else {
                    this.showFeedback(false, 'Try again!', `You said: "${transcript}". The correct word is "${item.english}". Click the speak button to try again.`);
                    this.playOopsSound();
                    
                    // Show arrows around speak button
                    this.recordBtn.classList.add('btn-with-arrows');
                    
                    // Audio feedback for wrong answer
                    setTimeout(() => {
                        this.speakEnglish(`Try again. The correct word is ${item.english}`);
                        setTimeout(() => {
                            this.speakEnglish(`Listen: ${item.english}`);
                        }, 2500);
                    }, 1000);
                    
                    setTimeout(() => {
                        this.startTimer(10);
                        this.micStatus.textContent = 'Click 🎤 Speak to try again';
                    }, 5000);
                }
            }

            // Create confetti animation
            createConfetti() {
                this.confettiContainer.innerHTML = '';
                
                for (let i = 0; i < 30; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    this.confettiContainer.appendChild(confetti);
                }
                
                setTimeout(() => {
                    this.confettiContainer.innerHTML = '';
                }, 4000);
            }

            // Celebrate success with animations
            celebrateSuccess() {
                this.createConfetti();
                this.wordDisplay.classList.add('celebrate');
                setTimeout(() => {
                    this.wordDisplay.classList.remove('celebrate');
                }, 600);
            }

            // Play success sound
            playSuccessSound() {
                this.playTone(660, 0.3);
                setTimeout(() => this.playTone(880, 0.3), 200);
            }

            // Play error sound
            playOopsSound() {
                this.playTone(400, 0.3);
                setTimeout(() => this.playTone(300, 0.3), 200);
            }

            // Generate audio tones
            playTone(frequency, duration) {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                } catch (error) {
                    console.log('Audio not supported');
                }
            }

            // Start countdown before moving to next word
            startCountdownToNext() {
                const overlay = document.createElement('div');
                overlay.className = 'countdown-overlay';
                this.wordDisplay.style.position = 'relative';
                this.wordDisplay.appendChild(overlay);
                
                let count = 4;
                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        overlay.innerHTML = `<div class="countdown-number">${count}</div>`;
                    } else {
                        clearInterval(countdownInterval);
                        overlay.remove();
                        this.nextItem();
                    }
                }, 1000);
                
                overlay.innerHTML = `<div class="countdown-number">${count}</div>`;
            }

            // Enhanced speech methods
            async speakEnglish(text) {
                if (!this.synthesis) return;
                await this.ensureVoicesReady();
                this.stopAllSpeech();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                
                if (this.voices && this.voices.length) {
                    const preferred = this.voices.find(v => /en(-|_)US/i.test(v.lang)) || this.voices.find(v => v.lang.startsWith('en'));
                    if (preferred) utterance.voice = preferred;
                }
                
                this.synthesis.speak(utterance);
            }

            async speakHindi(text) {
                if (!this.synthesis) return;
                await this.ensureVoicesReady();
                this.stopAllSpeech();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'hi-IN';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                
                if (this.voices && this.voices.length) {
                    const preferred = this.voices.find(v => /hi(-|_)IN/i.test(v.lang)) || this.voices.find(v => v.lang.startsWith('hi'));
                    if (preferred) utterance.voice = preferred;
                }
                
                this.synthesis.speak(utterance);
            }

            calculateSimilarity(str1, str2) {
                const longer = str1.length > str2.length ? str1 : str2;
                const shorter = str1.length > str2.length ? str2 : str1;
                
                if (longer.length === 0) return 1.0;
                
                const editDistance = this.levenshteinDistance(longer, shorter);
                return (longer.length - editDistance) / longer.length;
            }

            levenshteinDistance(str1, str2) {
                const matrix = [];
                
                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }
                
                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }
                
                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }
                
                return matrix[str2.length][str1.length];
            }

            showFeedback(isCorrect, text, hint) {
                this.feedbackSection.className = `feedback-section show ${isCorrect ? 'correct' : 'incorrect'}`;
                this.feedbackIcon.textContent = isCorrect ? '✅' : '❌';
                this.feedbackText.textContent = text;
                this.feedbackHint.textContent = hint;
            }

            startTimer(seconds) {
                if (this.timer) {
                    clearInterval(this.timer);
                }
                
                this.timeRemaining = seconds;
                this.timerCircle.classList.add('active');
                this.updateTimerDisplay();
                
                this.timer = setInterval(() => {
                    this.timeRemaining--;
                    this.updateTimerDisplay();
                    
                    if (this.timeRemaining <= 0) {
                        this.stopTimer();
                        if (this.isRecording) {
                            this.recognition.stop();
                        }
                    }
                }, 1000);
            }

            stopTimer() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                this.timerCircle.classList.remove('active');
            }

            updateTimerDisplay() {
                this.timerCircle.textContent = Math.max(0, this.timeRemaining);
            }

            updateProgress() {
                const currentPosition = this.currentIndex + 1;
                this.progressScore.textContent = `${currentPosition}/${this.totalItems}`;
                this.progressFill.style.width = `${(currentPosition / this.totalItems) * 100}%`;
            }

            nextItem() {
                this.currentIndex++;
                this.updateProgress();
                
                if (this.currentIndex >= this.vocabulary.length) {
                    this.showResults();
                } else {
                    this.showCurrentWord();
                }
                
                this.stopTimer();
            }

            showResults() {
                const percentage = Math.round((this.score / Math.max(this.totalAttempts, 1)) * 100);
                this.showFeedback(true, 'Chapter Complete!', `You scored ${percentage}%. Great work!`);
            }

            goBack() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.updateProgress();
                    this.showCurrentWord();
                }
            }

            showLessonSelection() {
                this.showFeedback(false, 'Feature Coming Soon', 'Lesson selection will be available in a future update!');
            }

            // NEW: Cleanup method to properly release resources
            cleanup() {
                if (this.audioStream) {
                    this.audioStream.getTracks().forEach(track => track.stop());
                    this.audioStream = null;
                }
                if (this.recognition) {
                    this.recognition.abort();
                }
                if (this.synthesis) {
                    this.synthesis.cancel();
                }
                if (this.timer) {
                    clearInterval(this.timer);
                }
            }
        }

        // Initialize app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new HindiLearningApp();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (app) app.cleanup();
        });
    </script>
</body>
</html>